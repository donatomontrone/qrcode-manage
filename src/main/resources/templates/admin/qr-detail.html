<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${qrCode.description + ' - QR Manager'}">Dettagli QR Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div th:replace="~{fragments/header :: header}"></div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumb -->
        <nav class="flex mb-8" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li><a href="/admin/dashboard" class="text-gray-500 hover:text-gray-700">Dashboard</a></li>
                <li><i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i></li>
                <li><a href="/admin/qr/list" class="text-gray-500 hover:text-gray-700">QR Code</a></li>
                <li><i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i></li>
                <li class="text-gray-900 font-medium" th:text="${qrCode.description}">Dettagli</li>
            </ol>
        </nav>

        <!-- Page Header -->
        <div class="flex justify-between items-start mb-8">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-2xl flex items-center justify-center mr-4">
                    <i data-lucide="qr-code" class="w-8 h-8 text-white"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900" th:text="${qrCode.description}">Collezione di Mario</h1>
                    <p class="text-gray-600">Proprietario: <span th:text="${qrCode.owner.fullName}">Mario Rossi</span></p>
                    <p class="text-sm text-gray-500">ID: <span th:text="${qrCode.qrId}" class="font-mono">qr_001</span></p>
                </div>
            </div>
            <div class="flex space-x-3">
                <a th:href="@{'/admin/qr/' + ${qrCode.id} + '/edit'}" 
                   class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:from-blue-700 hover:to-indigo-700 transition-all duration-200 flex items-center">
                    <i data-lucide="edit" class="w-4 h-4 mr-2"></i>
                    Modifica
                </a>
                <a th:href="@{'/admin/qr/' + ${qrCode.id} + '/image'}" target="_blank"
                   class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg font-medium hover:from-purple-700 hover:to-pink-700 transition-all duration-200 flex items-center">
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                    Scarica QR
                </a>
            </div>
        </div>

        <!-- Flash Messages -->
        <div th:if="${successMessage}" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mr-3"></i>
                <p class="text-green-800" th:text="${successMessage}">Operazione completata con successo!</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Info -->
            <div class="lg:col-span-2 space-y-6">
                <!-- QR Code Info -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Informazioni QR Code</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                            <p class="text-gray-900" th:text="${qrCode.description}">Collezione vintage di Mario</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Proprietario</label>
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-sm font-medium text-blue-600" th:text="${qrCode.owner.firstName?.substring(0,1)}">M</span>
                                </div>
                                <div>
                                    <p class="text-gray-900" th:text="${qrCode.owner.fullName}">Mario Rossi</p>
                                    <p class="text-sm text-gray-500" th:text="${qrCode.owner.email}">mario@email.com</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data Creazione</label>
                            <p class="text-gray-900" th:text="${#temporals.format(qrCode.createdAt, 'dd/MM/yyyy HH:mm')}">16/01/2025 14:30</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ultimo Aggiornamento</label>
                            <p class="text-gray-900" th:text="${#temporals.format(qrCode.updatedAt, 'dd/MM/yyyy HH:mm')}">18/01/2025 09:15</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data Scadenza</label>
                            <p th:classappend="${qrCode.isExpired()} ? 'text-red-600' : 'text-gray-900'" 
                               th:text="${#temporals.format(qrCode.expiryDate, 'dd/MM/yyyy HH:mm')}">31/12/2025 23:59</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Articoli</label>
                            <div class="flex items-center">
                                <div class="flex-1 bg-gray-200 rounded-full h-2 mr-3">
                                    <div class="bg-teal-500 h-2 rounded-full" th:style="'width: ' + ${qrCode.articles.size() * 100 / qrCode.maxArticles} + '%'"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-900" th:text="${qrCode.articles.size() + '/' + qrCode.maxArticles}">3/10</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Articles List -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-900">Articoli (<span th:text="${qrCode.articles.size()}">3</span>)</h2>
                        <a th:href="@{'/qr/' + ${qrCode.qrId}}" target="_blank"
                           class="text-teal-600 hover:text-teal-700 text-sm font-medium flex items-center">
                            <i data-lucide="external-link" class="w-4 h-4 mr-1"></i>
                            Visualizza Pagina Pubblica
                        </a>
                    </div>

                    <div th:if="${#lists.isEmpty(qrCode.articles)}" class="text-center py-8">
                        <i data-lucide="package-open" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Nessun articolo presente</h3>
                        <p class="text-gray-600">Gli articoli aggiunti dal proprietario appariranno qui.</p>
                    </div>

                    <div class="space-y-4" th:if="${!#lists.isEmpty(qrCode.articles)}">
                        <div th:each="article : ${qrCode.articles}" 
                             class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <div th:if="${article.imageUrl}" class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                                <img th:src="${article.imageUrl}" th:alt="${article.name}" class="w-full h-full object-cover">
                            </div>
                            <div th:if="${!article.imageUrl}" class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i data-lucide="image" class="w-8 h-8 text-gray-400"></i>
                            </div>

                            <div class="ml-4 flex-1">
                                <h3 class="font-medium text-gray-900" th:text="${article.name}">Nome Articolo</h3>
                                <p class="text-sm text-gray-600 mt-1" th:text="${article.description}">Descrizione articolo</p>
                                <p class="text-xs text-gray-500 mt-2">
                                    Aggiunto il <span th:text="${#temporals.format(article.createdAt, 'dd/MM/yyyy HH:mm')}">16/01/2025 15:30</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Status Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Status</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Stato:</span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                  th:classappend="${qrCode.status == 'ACTIVE'} ? 'bg-green-100 text-green-800' : 
                                                 ${qrCode.status == 'EXPIRED'} ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'"
                                  th:text="${qrCode.status == 'ACTIVE'} ? 'Attivo' : 
                                           ${qrCode.status == 'EXPIRED'} ? 'Scaduto' : 'Limite Raggiunto'">
                                Attivo
                            </span>
                        </div>

                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Scadenza:</span>
                            <span th:classappend="${qrCode.isExpired()} ? 'text-red-600' : 'text-green-600'" 
                                  class="text-sm font-medium">
                                <span th:if="${qrCode.isExpired()}">Scaduto</span>
                                <span th:if="${!qrCode.isExpired()}">Valido</span>
                            </span>
                        </div>

                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Può aggiungere:</span>
                            <span th:classappend="${qrCode.canAddArticle()} ? 'text-green-600' : 'text-red-600'" 
                                  class="text-sm font-medium">
                                <span th:if="${qrCode.canAddArticle()}">Si</span>
                                <span th:if="${!qrCode.canAddArticle()}">No</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- QR Code Preview -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 text-center">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">QR Code</h3>
                    <div class="w-48 h-48 mx-auto bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center mb-4">
                        <div class="text-center">
                            <i data-lucide="qr-code" class="w-16 h-16 text-gray-400 mx-auto mb-2"></i>
                            <p class="text-gray-500 text-sm">QR Code Preview</p>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <a th:href="@{'/admin/qr/' + ${qrCode.id} + '/image'}" target="_blank"
                           class="w-full bg-teal-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-teal-700 transition-colors flex items-center justify-center">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            Scarica PNG
                        </a>
                        <button onclick="copyToClipboard()" 
                                class="w-full border border-gray-300 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors flex items-center justify-center">
                            <i data-lucide="copy" class="w-4 h-4 mr-2"></i>
                            Copia URL
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Azioni</h3>
                    <div class="space-y-3">
                        <a th:href="@{'/admin/qr/' + ${qrCode.id} + '/edit'}" 
                           class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center">
                            <i data-lucide="edit" class="w-4 h-4 mr-2"></i>
                            Modifica QR Code
                        </a>

                        <button onclick="confirmDelete()" 
                                class="w-full bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center justify-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                            Elimina QR Code
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Form (hidden) -->
    <form th:action="@{'/admin/qr/' + ${qrCode.id} + '/delete'}" method="post" id="deleteForm" class="hidden">
        <input type="hidden" name="_method" value="delete">
    </form>

    <script>
        lucide.createIcons();

        function copyToClipboard() {
            const url = window.location.origin + '/qr/' + '[[${qrCode.qrId}]]';
            navigator.clipboard.writeText(url).then(() => {
                // Show toast notification
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                toast.textContent = 'URL copiato negli appunti!';
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            });
        }

        function confirmDelete() {
            if (confirm('Sei sicuro di voler eliminare questo QR Code? Questa azione non può essere annullata.')) {
                document.getElementById('deleteForm').submit();
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Crea QR Code - QR Manager</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
        <link th:href="@{/css/style.css}" rel="stylesheet" />

        <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {extend: {}}
            }
        </script>
    </head>
    <body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-200">

        <!-- Header -->
        <div th:replace="~{fragments/header :: header}"></div>
        <div id="toast-container" th:if="${qr != null}" class="fixed top-5 right-5 z-50 space-y-2">
            <div th:replace="fragments/toast :: toastFragment(${qr})"></div>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-200">Crea Nuovo QR Code</h1>
                <p class="text-gray-600 dark:text-gray-300">Genera un QR code personalizzato per un utente</p>
            </div>

            <!-- Layout Colonne -->
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Colonna sinistra -->
                <div class="flex-1 flex flex-col space-y-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                        <form th:action="@{/admin/qr/create}" th:object="${qrCodeDTO}" method="post" class="space-y-6">
                            <div>
                                <label for="ownerEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                    Email Proprietario *
                                </label>
                                <select id="ownerEmail" name="ownerEmail"
                                        class="tom-select"
                                        th:classappend="${#fields.hasErrors('ownerEmail')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500 dark:border-red-500' : ''"
                                        th:value="*{ownerEmail}">
                                    <option value="" disabled th:selected="${qrCodeDTO.ownerEmail == null}">Seleziona un email</option>
                                    <option th:each="user : ${users}" th:value="${user.email}" th:text="${user.email}" th:selected="${user.email == qrCodeDTO.ownerEmail}"></option>
                                </select>
                                <p th:if="${#fields.hasErrors('ownerEmail')}"
                                   th:errors="*{ownerEmail}"
                                   class="text-red-600 dark:text-red-400 text-sm mt-1"></p>
                                <p th:unless="${#fields.hasErrors('ownerEmail')}" class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                    Seleziona un utente registrato nel sistema
                                </p>
                            </div>

                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                    Descrizione
                                </label>
                                <input id="description" type="text" name="description"
                                       class="w-full border rounded-lg px-4 py-3 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100
                      focus:ring-2 focus:ring-teal-500 focus:border-transparent
                      border-gray-300 dark:border-gray-600"
                                       placeholder="Collezione vintage di Mario"
                                       th:classappend="${#fields.hasErrors('description')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500 dark:border-red-500' : ''"
                                       th:value="*{description}">
                                <p th:if="${#fields.hasErrors('description')}"
                                   th:errors="*{description}"
                                   class="text-sm mt-1 text-red-600 dark:text-red-400"></p>
                                <p th:unless="${#fields.hasErrors('description')}" class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                    Una breve descrizione del QR code
                                </p>
                            </div>

                            <div>
                                <label for="expiryDate" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                    Data di Scadenza*
                                </label>
                                <div class="relative">
                                <input id="expiryDate" type="text" name="expiryDate" datepicker datepicker-format="yyyy-mm-dd" datepicker-autohide="true"
                                       class="w-full border rounded-lg px-4 py-3 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100
                      focus:ring-2 focus:ring-teal-500 focus:border-transparent
                      border-gray-300 dark:border-gray-600" th:placeholder="${#dates.createToday().setYear(1)}"
                                       th:classappend="${#fields.hasErrors('expiryDate')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500 dark:border-red-500' : ''"
                                       th:value="*{expiryDate}">
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                        <i data-lucide="calendar" class="w-5 h-5" th:classappend="${#fields.hasErrors('expiryDate')} ? 'text-red-400' : 'text-gray-400'"></i>
                                    </div>
                                </div>
                                <p th:if="${#fields.hasErrors('expiryDate')}"
                                   th:errors="*{expiryDate}"
                                   class="text-red-600 dark:text-red-400 text-sm mt-1"></p>
                                <p th:unless="${#fields.hasErrors('expiryDate')}" class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                    Data di scadenza iniziale del QR code (default un anno)
                                </p>
                            </div>

                            <div>
                                <label for="maxArticles" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                    Numero Massimo Articoli
                                </label>
                                <div class="relative">
                                <input id="maxArticles" type="number" name="maxArticles"
                                       class="w-full border rounded-lg px-4 py-3 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100
                      focus:ring-2 focus:ring-teal-500 focus:border-transparent
                      border-gray-300 dark:border-gray-600"
                                       th:classappend="${#fields.hasErrors('maxArticles')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500 dark:border-red-500' : ''"
                                       th:value="*{maxArticles}">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                    <i data-lucide="package" class="w-5 h-5" th:classappend="${#fields.hasErrors('maxArticles')} ? 'text-red-400' : 'text-gray-400'"></i>
                                </div>
                            </div>
                                <p th:if="${#fields.hasErrors('maxArticles')}"
                                   th:errors="*{maxArticles}"
                                   class="text-red-600 dark:text-red-400 text-sm mt-1"></p>
                                <p th:unless="${#fields.hasErrors('maxArticles')}" class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                    Limite massimo di articoli associabili al QR code (default venti)
                                </p>
                            </div>

                            <button type="submit"
                                    class="flex-1 bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-3 px-6 rounded-lg font-medium hover:from-teal-700 hover:to-cyan-700 transition-all duration-200 flex items-center justify-center">
                                <i data-lucide="qr-code" class="w-5 h-5 mr-2"></i>
                                Genera QR Code
                            </button>
                        </form>
                    </div>

                    <div class="hidden lg:flex bg-yellow-50 dark:bg-yellow-900 rounded-xl border border-yellow-200 dark:border-yellow-800 py-14 px-6">
                        <div class="flex items-start">
                            <i data-lucide="triangle-alert" class="w-5 h-5 text-yellow-600 dark:text-yellow-300 mt-0.5 mr-3 flex-shrink-0"></i>
                            <div>
                                <h4 class="font-semibold text-yellow-900 dark:text-yellow-200 mb-2">Attenzione!</h4>
                                <ul class="text-sm text-yellow-800 dark:text-yellow-300 space-y-1">
                                    <li>• È possibile in un secondo momento riattivare il QR code</li>
                                    <li>• È possibile in un secondo momento aumentare il numero di articoli</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Colonna destra -->
                <div class="flex-1 flex flex-col gap-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Anteprima QR Code</h3>
                        <div class="flex flex-col items-center">
                            <div th:if="${qr == null}" class="w-48 h-48 bg-gray-100 dark:bg-gray-800 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg flex items-center justify-center mb-4">
                                <div class="text-center">
                                    <i data-lucide="qr-code" class="w-16 h-16 text-gray-400 mx-auto mb-2"></i>
                                    <p class="text-gray-500 dark:text-gray-400 text-sm">Il QR code apparirà qui</p>
                                </div>
                            </div>
                            <div th:if="${qr != null}"  class="w-48 h-48 bg-gray-100 dark:bg-gray-800 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg flex items-center justify-center mb-4">
                                <div class="text-center">
                                    <img th:src="'data:image/png;base64,' + ${qr}" alt="QR Code"
                                         class="w-48 h-46 rounded-lg"/>
                                </div>
                            </div>
                            <p th:if="${qr == null}" class="text-sm text-gray-600 dark:text-gray-400 text-center">
                                Il QR code sarà generato dopo la creazione e punterà a un indirizzo personale per utente
                            </p>
                            <a th:if="${qr != null}"
                               th:href="@{|mailto:${owner.getEmail()}?subject=Generazione%20spazio%20personale%20-%20QR%20Manager&body=Gentile%20${owner.getLastName() + ' ' + owner.getFirstName()},%0D%0A%0D%0Ati%20inviamo%20il%20link%20per%20accedere%20alla%20tua%20area%20personale.%20All’interno%20potrai%20visualizzare%20il%20tuo%20QR%20Code,%20scaricarlo%20e%20utilizzarlo%20per%20monitorare%20tutti%20gli%20articoli%20che%20desideri.%0D%0A%0D%0AIl%20link%20di%20accesso%20è%20:%20${url}%0D%0A%0D%0ALa%20scadenza%20del%20QR%20Code%20è%20fissata%20a%20un%20anno%20dalla%20sua%20emissione%20e%20potrai%20aggiungere%20fino%20a%2020%20articoli%20per%20QR%20Code.%0D%0A%0D%0ASe%20desideri%20prorogare%20la%20scadenza%20o%20aumentare%20il%20limite%20di%20articoli,%20non%20esitare%20a%20contattarci:%20saremo%20lieti%20di%20assisterti.%0D%0A%0D%0ACordiali%20saluti,%0D%0AIl%20team%20di%20QR%20Manager|}"
                               class="flex-1 bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-3 px-6 rounded-lg font-medium hover:from-teal-700 hover:to-cyan-700 transition-all duration-200 flex items-center justify-center">
                                <i data-lucide="mail" class="w-5 h-5 mr-2"></i>
                                <span>Invia <span class="hidden md:inline-flex">Email</span></span>
                            </a>
                        </div>
                    </div>

                    <div class="bg-blue-50 dark:bg-blue-900 rounded-xl border border-blue-200 dark:border-blue-800 p-6">
                        <div class="flex items-start">
                            <i data-lucide="info" class="w-5 h-5 text-blue-600 dark:text-blue-300 mt-0.5 mr-3 flex-shrink-0"></i>
                            <div>
                                <h4 class="font-semibold text-blue-900 dark:text-blue-200 mb-2">Come funziona</h4>
                                <ul class="text-sm text-blue-800 dark:text-blue-300 space-y-1">
                                    <li>• Il QR code sarà associato all'email specificata</li>
                                    <li>• L'utente potrà aggiungere articoli fino alla scadenza</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 p-6 flex-1 overflow-auto">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Utenti Recenti</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 "
                                 th:each="user, x : ${recentUsers}">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center" th:classappend="' bg-'+${colors[x.index]}+'-100'">
                                        <span class="text-sm font-medium" th:classappend="' text-'+${colors[x.index]}+'-600'"
                                              th:text="${#strings.toUpperCase(#strings.substring(user.getFirstName(), 0, 1))}">T</span>
                                    </div>
                                    <div class="ml-3" th:unless="${user.getEmail() == currentUser}">
                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-200" th:text="${user.getFirstName() + ' ' + user.getLastName()}">Sample Test</p>
                                        <p class="text-xs text-gray-600 dark:text-gray-300" th:text="${user.getEmail()}">sample.test@email.com</p>
                                    </div>
                                    <div class="ml-3" th:if="${user.getEmail() == currentUser}">
                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-200">Tu</p>
                                        <p class="text-xs text-gray-600 dark:text-gray-300" th:text="${user.getEmail()}">sample.test@email.com</p>
                                    </div>
                                </div>
                                <a th:href="@{'/admin/users/{id}'(id=${user.id})}" class="text-teal-600 hover:text-teal-700 text-xs cursor-pointer">Mostra</a>
                            </div>
                                <a href="/admin/users"
                                        class="bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-3 px-6 rounded-lg font-medium hover:from-teal-700
                    hover:to-cyan-700 transition-all duration-200 flex items-center justify-center">
                                    <i data-lucide="users" class="w-5 h-5 mr-2"></i>
                                    Mostra tutti
                                </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" name="darkMode" id="darkModeInput" value="">
        <script th:src="@{/js/app.js}"></script>
        <script th:if="${qr != null}">
            showToast();
        </script>
    </body>
</html>
